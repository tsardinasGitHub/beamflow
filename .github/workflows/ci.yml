name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  MIX_ENV: test
  ELIXIR_VERSION: "1.16"
  OTP_VERSION: "27"
  # Desactivar Chaos Monkey en CI
  CHAOS_ENABLED: "false"

jobs:
  test:
    name: Test (Elixir ${{ matrix.elixir }} / OTP ${{ matrix.otp }})
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        elixir: ["1.15", "1.16"]
        otp: ["26", "27"]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Elixir
        uses: erlef/setup-beam@v1
        with:
          elixir-version: ${{ matrix.elixir }}
          otp-version: ${{ matrix.otp }}
      
      - name: Restore dependencies cache
        uses: actions/cache@v4
        with:
          path: |
            deps
            _build
          key: ${{ runner.os }}-mix-${{ matrix.elixir }}-${{ matrix.otp }}-${{ hashFiles('**/mix.lock') }}
          restore-keys: |
            ${{ runner.os }}-mix-${{ matrix.elixir }}-${{ matrix.otp }}-
      
      - name: Install dependencies
        run: mix deps.get
      
      - name: Compile dependencies
        run: mix deps.compile
      
      - name: Compile project
        run: mix compile --warnings-as-errors
      
      - name: Check formatting
        run: mix format --check-formatted
      
      - name: Run tests
        run: mix test
        env:
          CHAOS_ENABLED: "false"

  quality:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Elixir
        uses: erlef/setup-beam@v1
        with:
          elixir-version: ${{ env.ELIXIR_VERSION }}
          otp-version: ${{ env.OTP_VERSION }}
      
      - name: Restore dependencies cache
        uses: actions/cache@v4
        with:
          path: |
            deps
            _build
          key: ${{ runner.os }}-mix-quality-${{ hashFiles('**/mix.lock') }}
          restore-keys: |
            ${{ runner.os }}-mix-quality-
      
      - name: Install dependencies
        run: mix deps.get
      
      - name: Run Credo
        run: mix credo --strict
      
      - name: Run Sobelow (Security)
        run: mix sobelow --config --exit

  coverage:
    name: Test Coverage
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Elixir
        uses: erlef/setup-beam@v1
        with:
          elixir-version: ${{ env.ELIXIR_VERSION }}
          otp-version: ${{ env.OTP_VERSION }}
      
      - name: Restore dependencies cache
        uses: actions/cache@v4
        with:
          path: |
            deps
            _build
          key: ${{ runner.os }}-mix-coverage-${{ hashFiles('**/mix.lock') }}
          restore-keys: |
            ${{ runner.os }}-mix-coverage-
      
      - name: Install dependencies
        run: mix deps.get
      
      - name: Run tests with coverage
        run: mix coveralls.json
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./cover/excoveralls.json
          fail_ci_if_error: false

  dialyzer:
    name: Dialyzer (Type Checking)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Elixir
        uses: erlef/setup-beam@v1
        with:
          elixir-version: ${{ env.ELIXIR_VERSION }}
          otp-version: ${{ env.OTP_VERSION }}
      
      - name: Restore dependencies cache
        uses: actions/cache@v4
        with:
          path: |
            deps
            _build
          key: ${{ runner.os }}-mix-dialyzer-${{ hashFiles('**/mix.lock') }}
          restore-keys: |
            ${{ runner.os }}-mix-dialyzer-
      
      - name: Restore PLT cache
        uses: actions/cache@v4
        id: plt-cache
        with:
          path: priv/plts
          key: ${{ runner.os }}-plt-${{ env.ELIXIR_VERSION }}-${{ env.OTP_VERSION }}-${{ hashFiles('**/mix.lock') }}
          restore-keys: |
            ${{ runner.os }}-plt-${{ env.ELIXIR_VERSION }}-${{ env.OTP_VERSION }}-
      
      - name: Install dependencies
        run: mix deps.get
      
      - name: Run Dialyzer
        run: mix dialyzer --format github

  # ============================================================================
  # Docker Build - Verificar que la imagen se construye correctamente
  # ============================================================================
  docker-build:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: [test, quality]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build Docker image (production)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          target: runtime
          push: false
          tags: beamflow:${{ github.sha }}
          build-args: |
            MIX_ENV=prod
            NODE_NAME=beamflow
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Build Docker image (development)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          target: development
          push: false
          tags: beamflow:dev-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============================================================================
  # Docker Compose - Verificar que los servicios se levantan
  # ============================================================================
  docker-compose-test:
    name: Docker Compose Test
    runs-on: ubuntu-latest
    needs: docker-build
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Create .env file for testing
        run: |
          echo "SECRET_KEY_BASE=$(openssl rand -base64 64 | tr -d '\n')" > .env
          echo "PHX_HOST=localhost" >> .env
          echo "PORT=4000" >> .env
          echo "CHAOS_ENABLED=false" >> .env
      
      - name: Build and start services
        run: docker compose up -d beamflow
        timeout-minutes: 10
      
      - name: Wait for service to be healthy
        run: |
          echo "Waiting for Beamflow to be ready..."
          for i in {1..30}; do
            if curl -s http://localhost:4000/api/health > /dev/null 2>&1; then
              echo "Beamflow is ready!"
              exit 0
            fi
            echo "Attempt $i/30 - waiting..."
            sleep 5
          done
          echo "Beamflow failed to start"
          docker compose logs beamflow
          exit 1
      
      - name: Show container logs on failure
        if: failure()
        run: docker compose logs beamflow
      
      - name: Cleanup
        if: always()
        run: docker compose down -v
